<div class="pedido-container" *ngIf="pedido">
  <!-- Adicione o modal de confirmação de cancelamento -->
  <app-confirm-modal
    [show]="showConfirmCancelModal"
    [title]="'Confirmar Cancelamento'"
    [message]="'Tem certeza que deseja cancelar a edição? Todas as alterações serão perdidas.'"
    [confirmText]="'Sim'"
    [cancelText]="'Não'"
    (confirm)="onConfirmCancel()"
    (cancel)="onCancelCancel()">
  </app-confirm-modal>

  <!-- Modal de confirmação de exclusão -->
  <app-confirm-modal
  [show]="showConfirmModal"
  [title]="'Confirmar Exclusão'"
  [message]="'Tem certeza que deseja excluir este pedido?'"
  [confirmText]="'Excluir'"
  [cancelText]="'Cancelar'"
  (confirm)="onConfirmDelete()"
  (cancel)="onCancelDelete()">
  </app-confirm-modal>

  <!-- Adicione o modal de confirmação de salvamento -->
  <app-confirm-modal
    [show]="showConfirmSaveModal"
    [title]="'Confirmar Alterações'"
    [message]="'Deseja salvar as alterações realizadas?'"
    [confirmText]="'Salvar'"
    [cancelText]="'Cancelar'"
    (confirm)="onConfirmSave()"
    (cancel)="onCancelSave()">
  </app-confirm-modal>

  <div class="pedido-header">
    <div class="header-left">
      <h2>Pedido #{{pedido.numero}}</h2>
      <span class="status-badge" [class]="getStatusClass(pedido.status)">
        {{pedido.status}}
      </span>
    </div>
    
    <div class="control-panel">
      <ng-container *ngIf="!isEditing">
        <button class="btn-primary" (click)="onEdit()">
          <i class="material-icons">edit</i>
          <span>Editar</span>
        </button>
        <button class="btn-secondary" (click)="onDelete()">
          <i class="material-icons">delete</i>
          <span>Excluir</span>
        </button>
        <button class="btn-secondary" (click)="onPrint()">
          <i class="material-icons">print</i>
          <span>Imprimir</span>
        </button>
        <button class="btn-secondary" (click)="onBack()">
          <i class="material-icons">arrow_back</i>
          <span>Voltar</span>
        </button>
      </ng-container>
      <ng-container *ngIf="isEditing">
        <button class="btn-primary" (click)="onSave()">
          <i class="material-icons">save</i>
          <span>Salvar</span>
        </button>
        <button class="btn-secondary" (click)="cancelEdit()">
          <i class="material-icons">close</i>
          <span>Cancelar</span>
        </button>
      </ng-container>
    </div>
  </div>

  <div class="content-grid">
    <div class="info-section">
      <h3>Informações Gerais</h3>
      <div class="info-grid">
        <div class="info-item" [class.error]="formErrors['descricao']">
          <label>Descrição</label>
          <ng-container *ngIf="!isEditing">
            <span>{{pedido.descricao}}</span>
          </ng-container>
          <ng-container *ngIf="isEditing">
            <input title="descricao" type="text" [(ngModel)]="pedido.descricao" name="descricao" required>
            <span class="error-message" *ngIf="formErrors['descricao']">{{formErrors['descricao']}}</span>
          </ng-container>
        </div>

        <div class="info-item" [class.error]="formErrors['solicitante']">
          <label>Solicitante</label>
          <ng-container *ngIf="!isEditing">
            <span>{{pedido.solicitante}}</span>
          </ng-container>
          <ng-container *ngIf="isEditing">
            <input title="solicitante" type="text" [(ngModel)]="pedido.solicitante" name="solicitante" required>
            <span class="error-message" *ngIf="formErrors['solicitante']">{{formErrors['solicitante']}}</span>
          </ng-container>
        </div>

        <div class="info-item" [class.error]="formErrors['categoria']">
          <label>Categoria</label>
          <ng-container *ngIf="!isEditing">
            <span>{{pedido.categoria}}</span>
          </ng-container>
          <ng-container *ngIf="isEditing">
            <select title="categoria" [(ngModel)]="pedido.categoria" name="categoria" required>
              <option *ngFor="let cat of categorias" [value]="cat">{{cat}}</option>
            </select>
            <span class="error-message" *ngIf="formErrors['categoria']">{{formErrors['categoria']}}</span>
          </ng-container>
        </div>

        <div class="info-item">
          <label>Prioridade</label>
          <ng-container *ngIf="!isEditing">
            <span [class]="'prioridade-' + pedido.prioridade.toLowerCase()">{{pedido.prioridade}}</span>
          </ng-container>
          <ng-container *ngIf="isEditing">
            <select title="prioridade" [(ngModel)]="pedido.prioridade" name="prioridade">
              <option *ngFor="let p of prioridades" [value]="p">{{p}}</option>
            </select>
          </ng-container>
        </div>
      </div>
    </div>

    <div class="info-section">
      <h3>Datas e Local</h3>
      <div class="info-grid">
        <!-- Data do Pedido não é editável -->
        <div class="info-item">
          <label>Data do Pedido</label>
          <span>{{formatDate(pedido.dataPedido)}}</span>
        </div>

        <div class="info-item" [class.error]="formErrors['dataEntrega']">
          <label>Data de Entrega</label>
          <ng-container *ngIf="!isEditing">
            <span>{{formatDate(pedido.dataEntrega)}}</span>
          </ng-container>
          <ng-container *ngIf="isEditing">
            <app-datepicker 
              [(value)]="pedido.dataEntrega"
              name="dataEntrega"
              placeholder="Selecione a data"
              required>
            </app-datepicker>
            <span class="error-message" *ngIf="formErrors['dataEntrega']">
              {{formErrors['dataEntrega']}}
            </span>
          </ng-container>
        </div>

        <div class="info-item" [class.error]="formErrors['enderecoEntrega']">
          <label>Local de Entrega</label>
          <ng-container *ngIf="!isEditing">
            <span>{{pedido.enderecoEntrega}}</span>
          </ng-container>
          <ng-container *ngIf="isEditing">
            <select title="enderecoEntrega" [(ngModel)]="pedido.enderecoEntrega" name="enderecoEntrega" required>
              <option *ngFor="let endereco of enderecos" [value]="endereco">{{endereco}}</option>
            </select>
            <span class="error-message" *ngIf="formErrors['enderecoEntrega']">{{formErrors['enderecoEntrega']}}</span>
          </ng-container>
        </div>

        <div class="info-item">
          <label>Tipo</label>
          <ng-container *ngIf="!isEditing">
            <span>{{pedido.paraEstoque ? 'Para Estoque' : 'Para Consumo'}}</span>
          </ng-container>
          <ng-container *ngIf="isEditing">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="pedido.paraEstoque" name="paraEstoque">
              Para Estoque
            </label>
          </ng-container>
        </div>
      </div>
    </div>

    <div class="info-section">
      <h3>OS Vinculada</h3>
      <ng-container *ngIf="!isEditing">
        <div class="os-info" *ngIf="pedido.OSVinculada">
          <span class="os-number">OS #{{pedido.OSVinculada.numero}}</span>
          <span class="os-desc">{{pedido.OSVinculada.descricaoServico}}</span>
        </div>
        <span *ngIf="!pedido.OSVinculada" class="no-os">Nenhuma OS vinculada</span>
      </ng-container>
      <ng-container *ngIf="isEditing">
        <div class="form-group">
          <label>Ordem de Serviço</label>
          <div class="os-select-container">
            <select title="OS-vinculada" [(ngModel)]="pedido.OSVinculada" 
                    name="osVinculada" 
                    class="os-select">
              <option [ngValue]="null">Nenhuma</option>
              <option *ngFor="let os of ordensDisponiveis" [ngValue]="os">
                OS #{{os.numero}} - {{os.descricaoServico}}
                <ng-container *ngIf="os.local">({{os.local}})</ng-container>
              </option>
            </select>
          </div>
          <span class="helper-text" *ngIf="!pedido.OSVinculada">
            Selecione uma OS para vincular ao pedido
          </span>
        </div>
      </ng-container>
    </div>

    <div class="info-section full-width">
      <h3>Insumos</h3>
      <div class="items-table">
        <table>
          <thead>
            <tr>
              <th>Descrição</th>
              <th class="text-center">Unidade</th>
              <th class="text-center">Quantidade</th>
              <th class="text-right">Valor Unit.</th>
              <th class="text-right">Total</th>
              <th *ngIf="isEditing" class="text-center">Ações</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let insumo of pedido.insumos; let i = index" 
                class="insumo-row" 
                [class.editing]="isEditing"
                (click)="!isEditing && showInsumoImages(insumo)">
              <td>{{insumo.descricao}}</td>
              <td class="text-center">{{insumo.unidade}}</td>
              <td class="text-center">
                <ng-container *ngIf="!isEditing">
                  {{insumo.quantidade}}
                </ng-container>
                <ng-container *ngIf="isEditing">
                  <input title="quantidade" type="number"
                         class="quantity-input"
                         [(ngModel)]="insumo.quantidade"
                         (ngModelChange)="onQuantidadeChange()"
                         min="1"
                         [name]="'quantidade_' + i">
                </ng-container>
              </td>
              <td class="text-right">{{insumo.valorUnitario | currency:'BRL'}}</td>
              <td class="text-right">
                {{calcularTotalInsumo(insumo.quantidade, insumo.valorUnitario) | currency:'BRL'}}
              </td>
              <td *ngIf="isEditing" class="text-center actions">
                <button class="btn-icon delete" 
                        (click)="removerInsumo(i)"
                        title="Remover insumo">
                  <i class="material-icons">delete</i>
                </button>
              </td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="text-right"><strong>Total do Pedido:</strong></td>
              <td class="text-right"><strong>{{pedido.valorTotal | currency:'BRL'}}</strong></td>
              <td *ngIf="isEditing"></td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="insumo-form" *ngIf="isEditing">
        <div class="form-row">
          <div class="form-group flex-2">
            <label>Adicionar insumo</label>
            <select title="insumo" [(ngModel)]="insumoSelecionado" 
                    name="insumo"
                    (ngModelChange)="onInsumoSelect($event)">
              <option [ngValue]="null">Selecione um insumo</option>
              <option *ngFor="let insumo of insumosDisponiveis" [ngValue]="insumo">
                {{insumo.descricao}} ({{insumo.unidade}}) - {{insumo.valorUnitario | currency:'BRL'}}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Quantidade</label>
            <input title="quantidade" type="number" 
                   [(ngModel)]="quantidade" 
                   name="quantidade"
                   min="1"
                   [disabled]="!insumoSelecionado">
          </div>

          <div class="form-actions">
            <button type="button" 
                    class="btn-add" 
                    (click)="adicionarInsumo()"
                    [disabled]="!insumoSelecionado || !quantidade || quantidade < 1">
              <i class="material-icons">add</i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="info-section full-width" *ngIf="pedido.observacoes">
      <h3>Observações</h3>
      <p class="observacoes">{{pedido.observacoes}}</p>
    </div>
  </div>

  <app-alert-modal
    [show]="showAlertModal"
    [title]="alertTitle"
    [message]="alertMessage"
    [buttonText]="'OK'"
    (close)="onCloseAlert()">
  </app-alert-modal>

  
</div>

<div class="image-modal" *ngIf="showImageModal" (click)="closeImageModal()" tabindex="0">
  <div class="modal-content" (click)="onModalClick($event)">
    <div class="modal-header">
      <h3>{{selectedInsumo?.nome}}</h3>
      <div class="modal-controls">
        <button class="btn-modal" (click)="toggleHint()" title="Ajuda">
          <i class="material-icons">help_outline</i>
        </button>
        <button class="btn-close-modal" (click)="closeImageModal()">
          <i class="material-icons">close</i>
        </button>
      </div>
    </div>
    
    <div class="image-container" *ngIf="selectedInsumo">
      <button class="nav-button prev" 
              *ngIf="currentImageIndex > 0"
              (click)="previousImage()">
        <i class="material-icons color-white">chevron_left</i>
      </button>
      
      <img title="imagem-insumo" class="material-image" [src]="selectedInsumo.enderecosImagens[currentImageIndex]" 
           [alt]="selectedInsumo.nome">
      
      <button class="nav-button next" 
              *ngIf="selectedInsumo.enderecosImagens.length > currentImageIndex + 1"
              (click)="nextImage()">
        <i class="material-icons">chevron_right</i>
      </button>
    </div>
    
    <div class="image-counter" *ngIf="selectedInsumo && selectedInsumo.enderecosImagens">
      {{currentImageIndex + 1}} / {{selectedInsumo.enderecosImagens.length}}
    </div>
    
    <div class="keyboard-hint" *ngIf="showHint">
      <span><i class="material-icons">keyboard_arrow_left</i> / <i class="material-icons">keyboard_arrow_right</i> para navegar</span>
      <span><i class="material-icons">close</i> ESC para fechar</span>
    </div>
  </div>
</div>

